<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Расписание занятий</title>
  <link rel="manifest" href="/manifest.json">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f7fa;
      padding: 15px;
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    header {
      background: #007BFF;
      color: white;
      padding: 25px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
    }
    header h1 {
      font-size: 1.8rem;
      font-weight: 600;
    }
    .sticky-toolbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #007BFF;
      color: white;
      padding: 12px 0;
      text-align: center;
      font-weight: 600;
      z-index: 99;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      font-size: 0.95rem;
    }
    .container {
      margin-top: 80px;
      margin-bottom: 80px;
      max-width: 900px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .day-header {
      background: #f0f4ff;
      color: #333;
      text-align: center;
      padding: 16px;
      margin: 12px 0;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: relative;
    }
    .day-header::after {
      content: ' ▼';
      font-size: 0.9em;
      margin-left: 6px;
    }
    .day-header.active::after {
      content: ' ▲';
    }
    .day-header.today {
      background: #d4edff;
      color: #004085;
      font-weight: 700;
      border: 2px solid #007BFF;
      box-shadow: 0 0 0 3px #cce5ff;
    }
    .date-badge {
      font-size: 0.85rem;
      color: #666;
      font-weight: 500;
      position: absolute;
      top: 8px;
      right: 12px;
      background: #e0e0e0;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .time-left {
      font-size: 0.8rem;
      color: #8E44AD;
      font-weight: 500;
      display: block;
      margin-top: 6px;
      letter-spacing: 0.3px;
      text-align: center;
      width: 100%;
    }
    .entry {
      display: flex;
      justify-content: space-between;
      padding: 14px 16px;
      background: white;
      border: 1px solid #eee;
      border-radius: 10px;
      margin-bottom: 10px;
      position: relative;
      flex-direction: column;
    }
    .entry-top {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 4px;
    }
    .time { font-weight: 600; min-width: 70px; }
    .lesson { flex: 1; }
    .students { font-weight: 600; min-width: 100px; text-align: right; }
    
    .entry.past {
      background: #f8f9fa;
      color: #adb5bd;
      opacity: 0.6;
      border-left: 3px solid #dee2e6;
    }
    .entry.current {
      background: #e3f2fd;
      color: #0d47a1;
      border-left: 3px solid #007BFF;
      font-weight: 600 !important;
    }
    .entry.current .lesson,
    .entry.current .students {
      font-weight: 600;
    }
    .school { color: #c62828; }
    .private { color: #1565c0; }
    .other { color: #000; }
    .rest-day-container {
      text-align: center;
      color: #2e7d32;
      background: #e8f5e9;
      border: 2px dashed #4caf50;
      border-radius: 12px;
      padding: 20px;
      font-weight: 600;
      position: relative;
    }
    .rest-day-text {
      font-style: italic;
      line-height: 1.6;
      max-width: 80%;
      margin: 10px auto;
      font-size: 0.95rem;
    }
    .day-content {
      display: block;
    }
    .day-content.closed {
      display: none;
    }
    .toolbar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #f8f9fa;
      border-top: 1px solid #dee2e6;
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 100;
    }
    .toolbar button {
      background: #e9ecef;
      color: #495057;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      margin: 0 5px;
      max-width: 30%;
    }
    .toolbar button:hover {
      background: #dde0e4;
      transform: translateY(-1px);
    }
    .toolbar button.active {
      background: #007BFF;
      color: white;
      font-weight: 600;
    }
    .toolbar button.active:hover {
      background: #0069d9;
    }
    .notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(128, 128, 128, 0.9);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s ease;
      max-width: 90%;
      text-align: center;
      font-size: 1.05rem;
      font-weight: 500;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .notification.show {
      opacity: 1;
      visibility: visible;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .modal-title {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .btn-secondary {
      background: #e9ecef;
      color: #495057;
    }
    .btn-primary {
      background: #007BFF;
      color: white;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn:hover {
      opacity: 0.9;
    }
    .entry-actions {
      display: flex;
      gap: 5px;
      margin-top: 6px;
    }
    .btn-action {
      padding: 4px 8px;
      font-size: 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-edit {
      background: #ffc107;
      color: #212529;
    }
    .btn-delete {
      background: #dc3545;
      color: white;
    }
  </style>
</head>
<body>
  <div class="sticky-toolbar" id="next-lesson-bar">
    Загрузка информации о следующем занятии...
  </div>

  <div class="container">
    <header><h1>Расписание занятий</h1></header>
    <div class="schedule" id="schedule-container">
      <!-- Содержимое будет генерироваться динамически -->
    </div>
  </div>

  <div style="position: fixed; bottom: 90px; right: 20px; z-index: 101;">
    <button class="btn btn-primary" onclick="openAddModal()">+</button>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Добавить занятие</h2>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <form id="editForm">
        <input type="hidden" id="editId">
        <div class="form-group">
          <label for="editDay">День недели</label>
          <select id="editDay" required>
            <option value="sun">Воскресенье</option>
            <option value="mon">Понедельник</option>
            <option value="tue">Вторник</option>
            <option value="wed">Среда</option>
            <option value="thu">Четверг</option>
            <option value="fri">Пятница</option>
            <option value="sat">Суббота</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editTime">Время</label>
          <input type="time" id="editTime" required>
        </div>
        <div class="form-group">
          <label for="editLesson">Занятие</label>
          <input type="text" id="editLesson" placeholder="Например: Английский язык" required>
        </div>
        <div class="form-group">
          <label for="editStudents">Ученики</label>
          <input type="text" id="editStudents" placeholder="Например: Тереза">
        </div>
        <div class="form-group">
          <label for="editType">Тип занятия</label>
          <select id="editType" required>
            <option value="school">Школа (красный)</option>
            <option value="private">Частный (синий)</option>
            <option value="other">Другое</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Отмена</button>
          <button type="button" class="btn btn-danger" id="deleteBtn" onclick="confirmDelete()">Удалить</button>
          <button type="submit" class="btn btn-primary">Сохранить</button>
        </div>
      </form>
    </div>
  </div>

  <div class="toolbar">
    <button id="btn-prev" onclick="goToWeek(-1)">Предыдущая неделя</button>
    <button id="btn-current" onclick="goToCurrentWeek()">Эта неделя</button>
    <button id="btn-next" onclick="goToWeek(1)">Следующая неделя</button>
  </div>

  <div class="notification" id="notification"></div>

  <script>
    const sabbathVerses = [
      "Помни день субботний, чтобы святить его; шесть дней работай и делай всякие дела твои, а день седьмой — суббота Господу, Богу твоему: не делай в оный никакого дела ни ты, ни сын твой, ни дочь твоя, ни раб твой, ни рабыня твоя, ни скот твой, ни пришлец, который в жилищах твоих; ибо в шесть дней создал Господь небо и землю, море и всё, что в них, а в день седьмой почил; посему благословил Господь день субботний и освятил его. (Исход 20:8-11)",
      "Я Господь Бог ваш: по Моим заповедям поступайте, и Мои уставы соблюдайте и исполняйте их. И святите субботы Мои, чтобы они были знамением между Мною и вами, дабы вы знали, что Я Господь Бог ваш. (Иезекииль 20:19-20)",
      "Наблюдай день субботний, чтобы свято хранить его, как заповедал тебе Господь, Бог твой; шесть дней работай и делай всякие дела твои, а день седьмой — суббота Господу, Богу твоему. Не делай в оный никакого дела, ни ты, ни сын твой, ни дочь твоя, ни раб твой, ни раба твоя, ни вол твой, ни осел твой, ни всякий скот твой, ни пришелец твой, который у тебя, чтобы отдохнул раб твой, и раба твоя и осел твой, как и ты. (Второзаконие 5:12-14)",
      "Если ты удержишь ногу твою ради субботы от исполнения прихотей твоих во святый день Мой, и будешь называть субботу отрадою, святым днем Господним, чествуемым, и почтишь ее тем, что не будешь заниматься обычными твоими делами, угождать твоей прихоти и пустословить, — то будешь иметь радость в Господе, и Я возведу тебя на высоты земли и дам вкусить тебе наследие Иакова, отца твоего: уста Господни изрекли это. (Исаия 58:13-14)",
      "И благословил Бог седьмой день, и освятил его, ибо в оный почил от всех дел Своих, которые Бог творил и созидал. (Бытие 2:3)",
      "И случилось Ему в субботу проходить засеянными полями, и ученики Его дорогою начали срывать колосья. И фарисеи сказали Ему: смотри, что́ они делают в субботу, чего не должно делать? Он сказал им: неужели вы не читали никогда, что́ сделал Давид, когда имел нужду и взалкал сам и бывшие с ним? как вошел он в дом Божий при первосвященнике Авиафаре и ел хлебы предложения, которых не должно было есть никому, кроме священников, и дал и бывшим с ним? И сказал им: суббота для человека, а не человек для субботы; посему Сын Человеческий есть господин и субботы. (От Марка 2:23-28)",
      "Сколько же лучше человек овцы! Итак можно в субботы делать добро. (От Матфея 12:12)",
      "Посему для народа Божия еще остается субботство. Ибо кто вошел в покой Его, тот и сам успокоился от дел своих, как и Бог от Своих. (К Евреям 4:9-10)",
      "Шесть дней можно делать дела, а в седьмой день суббота покоя, священное собрание; никакого дела не делайте; это суббота Господня во всех жилищах ваших. (Левит 23:3)",
      "Субботы Мои соблюдайте и святилище Мое чтите: Я Господь. (Левит 26:2)",
      "Итак, постараемся войти в покой оный, чтобы кто по тому же примеру не впал в непокорность. (К Евреям 4:11)",
      "В одной из синагог учил Он в субботу. Там была женщина, восемнадцать лет имевшая духа немощи: она была скорчена и не могла выпрямиться. Иисус, увидев ее, подозвал и сказал ей: женщина! ты освобождаешься от недуга твоего. И возложил на нее руки, и она тотчас выпрямилась и стала славить Бога. При этом начальник синагоги, негодуя, что Иисус исцелил в субботу, сказал народу: есть шесть дней, в которые должно делать; в те и приходи́те исцеляться, а не в день субботний. Господь сказал ему в ответ: лицемер! не отвязывает ли каждый из вас вола своего или осла от яслей в субботу и не ведет ли поить? сию же дочь Авраамову, которую связал сатана вот уже восемнадцать лет, не надлежало ли освободить от уз сих в день субботний? И когда говорил Он это, все противившиеся Ему стыдились; и весь народ радовался о всех славных делах Его. (От Луки 13:10-17)",
      "И помни, что ты был рабом в земле Египетской, но Господь, Бог твой, вывел тебя оттуда рукою крепкою и мышцею высокою, потому и повелел тебе Господь, Бог твой, соблюдать день субботний и свято хранить его. (Второзаконие 5:15)"
    ];

    // Ключ для localStorage
    const STORAGE_KEY = 'scheduleData_v1';
    
    // Массив для хранения всех занятий
    let scheduleData = [];

    // Инициализация: загрузка данных из localStorage или установка данных по умолчанию
    function initScheduleData() {
      const savedData = localStorage.getItem(STORAGE_KEY);
      if (savedData) {
        try {
          scheduleData = JSON.parse(savedData);
          console.log('Данные загружены из localStorage');
        } catch (e) {
          console.error('Ошибка при парсинге данных из localStorage:', e);
          // Если данные повреждены, используем данные по умолчанию
          scheduleData = getDefaultSchedule();
        }
      } else {
        // Данные по умолчанию из PDF
        scheduleData = getDefaultSchedule();
      }
    }

    // Получение расписания по умолчанию
    function getDefaultSchedule() {
      return [
        { id: 'sun-0', day: 'sun', time: '10:00', lesson: 'Французский', students: 'Тереза', type: 'private' },
        { id: 'mon-0', day: 'mon', time: '18:00', lesson: 'Английский', students: 'Тереза', type: 'private' },
        { id: 'mon-1', day: 'mon', time: '19:00', lesson: 'Английский', students: 'Злата', type: 'private' },
        { id: 'tue-0', day: 'tue', time: '09:55', lesson: 'Английский', students: '5 класс', type: 'school' },
        { id: 'tue-1', day: 'tue', time: '10:45', lesson: 'Английский', students: '4 класс', type: 'school' },
        { id: 'tue-2', day: 'tue', time: '11:35', lesson: 'Английский', students: '2 класс', type: 'school' },
        { id: 'tue-3', day: 'tue', time: '12:25', lesson: 'Английский', students: '3 класс', type: 'school' },
        { id: 'tue-4', day: 'tue', time: '19:00', lesson: 'Английский', students: 'Аня', type: 'private' },
        { id: 'wed-0', day: 'wed', time: '09:55', lesson: 'Английский', students: '4 класс', type: 'school' },
        { id: 'wed-1', day: 'wed', time: '10:45', lesson: 'Английский', students: '3 класс', type: 'school' },
        { id: 'wed-2', day: 'wed', time: '11:35', lesson: 'Английский', students: '2 класс', type: 'school' },
        { id: 'wed-3', day: 'wed', time: '12:25', lesson: 'Английский', students: '1 класс', type: 'school' },
        { id: 'wed-4', day: 'wed', time: '13:25', lesson: 'Английский', students: '5 класс', type: 'school' },
        { id: 'wed-5', day: 'wed', time: '19:00', lesson: 'Английский', students: 'Злата', type: 'private' },
        { id: 'wed-6', day: 'wed', time: '20:00', lesson: 'Французский', students: 'Тереза', type: 'private' },
        { id: 'thu-0', day: 'thu', time: '09:55', lesson: 'Английский', students: '5 класс', type: 'school' },
        { id: 'thu-1', day: 'thu', time: '10:45', lesson: 'Английский', students: '4 класс', type: 'school' },
        { id: 'thu-2', day: 'thu', time: '11:35', lesson: 'Английский', students: '2 класс', type: 'school' },
        { id: 'thu-3', day: 'thu', time: '12:25', lesson: 'Английский', students: '1 класс', type: 'school' },
        { id: 'thu-4', day: 'thu', time: '13:25', lesson: 'Английский', students: '3 класс', type: 'school' },
        { id: 'thu-5', day: 'thu', time: '18:00', lesson: 'Английский', students: 'Злата', type: 'private' },
        { id: 'thu-6', day: 'thu', time: '19:00', lesson: 'Английский', students: 'Аня', type: 'private' },
        { id: 'fri-0', day: 'fri', time: 'День', lesson: 'Уборка и учёба', students: '', type: 'other' }
      ];
    }

    // Сохранение данных в localStorage
    function saveToLocalStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(scheduleData));
        console.log('Данные сохранены в localStorage');
      } catch (e) {
        console.error('Ошибка при сохранении в localStorage:', e);
        showNotification('Ошибка сохранения. Данные могут быть потеряны.');
      }
    }

    // Генерация нового уникального ID
    function generateId(day) {
      const dayEntries = scheduleData.filter(item => item.day === day);
      return `${day}-${dayEntries.length}`;
    }

    // Обновление DOM на основе scheduleData
    function updateScheduleDOM() {
      const container = document.getElementById('schedule-container');
      container.innerHTML = ''; // Очищаем контейнер

      const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
      const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];

      dayKeys.forEach((dayKey, index) => {
        const dayName = dayNames[index];
        
        // Создаем заголовок дня
        const header = document.createElement('div');
        header.className = 'day-header';
        header.id = `header-${dayKey}`;
        header.onclick = () => toggle(dayKey);
        header.innerHTML = `${dayName}<span class="date-badge" id="date-${dayKey}">--.--.--</span>`;
        container.appendChild(header);

        // Создаем контент дня
        const content = document.createElement('div');
        content.className = 'day-content';
        content.id = `content-${dayKey}`;
        container.appendChild(content);

        // Если это суббота, добавляем контейнер дня покоя
        if (dayKey === 'sat') {
          const restContainer = document.createElement('div');
          restContainer.className = 'rest-day-container';
          restContainer.innerHTML = `
            День покоя
            <div class="rest-day-text" id="sabbath-verse"></div>
          `;
          content.appendChild(restContainer);
          return; // Пропускаем добавление обычных занятий для субботы
        }

        // Фильтруем и сортируем занятия для этого дня
        const dayEntries = scheduleData
          .filter(item => item.day === dayKey)
          .sort((a, b) => {
            const timeA = a.time.split(':').map(Number);
            const timeB = b.time.split(':').map(Number);
            return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
          });

        // Добавляем каждое занятие
        dayEntries.forEach(entry => {
          const entryElement = document.createElement('div');
          entryElement.className = `entry ${entry.type}`;
          entryElement.setAttribute('data-id', entry.id);
          
          entryElement.innerHTML = `
            <div class="entry-top">
              <div class="time">${entry.time}</div>
              <div class="lesson">${entry.lesson}</div>
              <div class="students">${entry.students}</div>
            </div>
            <div class="entry-actions">
              <button class="btn-action btn-edit" onclick="editEntry('${entry.id}')">Изменить</button>
              <button class="btn-action btn-delete" onclick="deleteEntry('${entry.id}')">Удалить</button>
            </div>
          `;
          
          content.appendChild(entryElement);
        });
      });

      // После генерации DOM, обновляем неделю (даты и состояние)
      updateWeek();
    }

    function toggle(day) {
      const content = document.getElementById('content-' + day);
      const header = document.getElementById('header-' + day);
      if (!content || !header) return;

      const isClosed = content.classList.contains('closed');
      if (isClosed) {
        content.classList.remove('closed');
        header.classList.remove('active');
      } else {
        content.classList.add('closed');
        header.classList.add('active');
      }
    }

    function goToWeek(offset) {
      currentOffset = offset;
      updateWeek();
    }

    function goToCurrentWeek() {
      currentOffset = 0;
      updateWeek();
    }

    let currentOffset = 0;
    const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    const buttons = {
      prev: document.getElementById('btn-prev'),
      current: document.getElementById('btn-current'),
      next: document.getElementById('btn-next')
    };
    const nextLessonBar = document.getElementById('next-lesson-bar');
    const notification = document.getElementById('notification');
    const modal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const modalTitle = document.getElementById('modalTitle');
    const deleteBtn = document.getElementById('deleteBtn');

    function updateWeek() {
      const today = new Date();
      const target = new Date(today);
      target.setDate(today.getDate() + currentOffset * 7);

      const dayOfWeek = target.getDay();
      const monday = new Date(target);
      const diff = target.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
      monday.setDate(diff);
      monday.setHours(0, 0, 0, 0);

      for (let i = 0; i < 7; i++) {
        let date;
        if (i === 0) {
          date = new Date(monday);
          date.setDate(monday.getDate() - 1);
        } else {
          date = new Date(monday);
          date.setDate(monday.getDate() + i - 1);
        }

        const dayKey = days[i];
        const dateElement = document.getElementById('date-' + dayKey);
        if (dateElement) {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = String(date.getFullYear()).slice(-2);
          dateElement.textContent = `${day}.${month}.${year}`;
        }
      }

      const todayIndex = new Date().getDay();
      const isCurrentWeek = currentOffset === 0;

      const currentDayKey = days[todayIndex];
      for (let i = 0; i < 7; i++) {
        const dayKey = days[i];
        const header = document.getElementById('header-' + dayKey);
        if (header) {
          header.classList.remove('today');
          if (isCurrentWeek && dayKey === currentDayKey) {
            header.classList.add('today');
          }
        }

        const content = document.getElementById('content-' + dayKey);
        if (content) {
          if (currentOffset !== 0) {
            content.classList.remove('closed');
            header.classList.remove('active');
          } else {
            if (i < todayIndex) {
              content.classList.add('closed');
              document.getElementById('header-' + dayKey).classList.add('active');
            } else if (i === todayIndex) {
              const allLessonsEnded = areAllLessonsEnded(dayKey);
              if (allLessonsEnded) {
                content.classList.add('closed');
                header.classList.add('active');
              } else {
                content.classList.remove('closed');
                header.classList.remove('active');
              }
            } else {
              content.classList.remove('closed');
              header.classList.remove('active');
            }
          }
        }
      }

      buttons.prev.classList.remove('active');
      buttons.current.classList.remove('active');
      buttons.next.classList.remove('active');

      if (currentOffset === -1) {
        buttons.prev.classList.add('active');
      } else if (currentOffset === 0) {
        buttons.current.classList.add('active');
      } else if (currentOffset === 1) {
        buttons.next.classList.add('active');
      }

      const verseElement = document.getElementById('sabbath-verse');
      if (verseElement) {
        const randomIndex = Math.floor(Math.random() * sabbathVerses.length);
        verseElement.textContent = sabbathVerses[randomIndex];
      }

      if (currentOffset === 0) {
        markCurrentAndPastLessons();
        updateNextLessonInfo();
      } else {
        document.querySelectorAll('.time-left').forEach(el => el.remove());
        document.querySelectorAll('.entry').forEach(el => {
          el.classList.remove('past', 'current');
        });
        nextLessonBar.textContent = 'Перейдите на текущую неделю';
      }
    }

    function areAllLessonsEnded(day) {
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentTotalMinutes = currentHour * 60 + currentMinute;

      // Получаем времена занятий для этого дня из scheduleData
      const dayEntries = scheduleData.filter(item => item.day === day);
      const times = dayEntries.map(item => item.time).filter(time => time !== 'День'); // Исключаем "День"

      // Продолжительность занятий
      const durations = {
        school: 40,
        private: 60,
        other: 0
      };

      for (const entry of dayEntries) {
        if (entry.time === 'День') continue; // Пропускаем "День"
        
        const [h, m] = entry.time.split(':').map(Number);
        const duration = durations[entry.type] || 0;
        const lessonEnd = (h * 60 + m) + duration;
        
        if (lessonEnd > currentTotalMinutes) {
          return false;
        }
      }
      return true;
    }

    function markCurrentAndPastLessons() {
      const now = new Date();
      const currentDayIndex = now.getDay();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentTotalMinutes = currentHour * 60 + currentMinute;

      const currentDayKey = days[currentDayIndex];
      const dayEntries = scheduleData.filter(item => item.day === currentDayKey && item.time !== 'День');

      document.querySelectorAll('.entry').forEach(el => {
        el.classList.remove('past', 'current');
      });

      const entries = document.querySelectorAll(`#content-${currentDayKey} .entry`);
      for (let i = 0; i < entries.length; i++) {
        const entryData = dayEntries[i];
        if (!entryData) break;

        const [h, m] = entryData.time.split(':').map(Number);
        const lessonStart = h * 60 + m;
        const duration = entryData.type === 'school' ? 40 : 
                        entryData.type === 'private' ? 60 : 0;
        const lessonEnd = lessonStart + duration;

        if (currentTotalMinutes >= lessonEnd) {
          entries[i].classList.add('past');
        } else if (currentTotalMinutes >= lessonStart && currentTotalMinutes < lessonEnd) {
          entries[i].classList.add('current');
        } else {
          break;
        }
      }
    }

    function updateNextLessonInfo() {
      const now = new Date();
      const currentDayIndex = now.getDay();
      const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();

      const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
      const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];

      const target = new Date(now);
      const monday = new Date(target);
      const diff = target.getDate() - (target.getDay() === 0 ? 6 : target.getDay() - 1);
      monday.setDate(diff);
      monday.setHours(0, 0, 0, 0);

      for (let i = 0; i < 7; i++) {
        const dayKey = dayKeys[i];
        const dayEntries = scheduleData.filter(item => item.day === dayKey);

        for (const entry of dayEntries) {
          if (entry.time === 'День') continue; // Пропускаем "День"

          const [h, m] = entry.time.split(':').map(Number);
          const lessonDate = new Date(monday);
          lessonDate.setDate(monday.getDate() + i - 1);
          if (i === 0) lessonDate.setDate(lessonDate.getDate() - 1);

          const lessonDateTime = new Date(lessonDate);
          lessonDateTime.setHours(h, m, 0, 0);

          if (lessonDateTime > now) {
            const dayName = dayNames[i];
            const day = String(lessonDate.getDate()).padStart(2, '0');
            const month = String(lessonDate.getMonth() + 1).padStart(2, '0');
            const year = lessonDate.getFullYear();
            const formattedDate = `${day}.${month}.${year}`;

            nextLessonBar.textContent = `Следующее занятие в ${h}:${m}, в ${dayName} ${formattedDate}`;
            showTimerOnNextLesson(i, entry.id, lessonDateTime, now);
            return;
          }
        }
      }

      nextLessonBar.textContent = 'На этой неделе занятий больше нет';
      document.querySelectorAll('.time-left').forEach(el => el.remove());
    }

    function showTimerOnNextLesson(dayIndex, entryId, lessonDateTime, now) {
      document.querySelectorAll('.time-left').forEach(el => el.remove());

      const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
      const dayKey = dayKeys[dayIndex];
      const content = document.getElementById('content-' + dayKey);
      
      if (!content) return;

      const targetEntry = document.querySelector(`[data-id="${entryId}"]`);
      if (!targetEntry) return;

      const diffMs = lessonDateTime - now;
      const diffMinutes = Math.floor(diffMs / 60000);
      if (diffMinutes <= 0) return;

      const hours = Math.floor(diffMinutes / 60);
      const mins = diffMinutes % 60;

      const span = document.createElement('span');
      span.className = 'time-left';

      if (hours === 0) {
        span.textContent = `начнется через ${mins} мин.`;
      } else if (mins === 0) {
        span.textContent = `начнется через ${hours} ч.`;
      } else {
        span.textContent = `начнется через ${hours} ч. ${mins} мин.`;
      }

      targetEntry.appendChild(span);
    }

    function showNotification(message) {
      const notif = document.getElementById('notification');
      notif.textContent = message;
      notif.classList.add('show');

      setTimeout(() => {
        notif.classList.remove('show');
      }, 5000);
    }

    // Функции для модального окна
    function openAddModal() {
      modalTitle.textContent = 'Добавить занятие';
      editForm.reset();
      document.getElementById('editId').value = '';
      deleteBtn.style.display = 'none';
      modal.style.display = 'block';
    }

    function openEditModal(entry) {
      modalTitle.textContent = 'Изменить занятие';
      document.getElementById('editId').value = entry.id;
      document.getElementById('editDay').value = entry.day;
      document.getElementById('editTime').value = entry.time;
      document.getElementById('editLesson').value = entry.lesson;
      document.getElementById('editStudents').value = entry.students;
      document.getElementById('editType').value = entry.type;
      deleteBtn.style.display = 'inline-block';
      modal.style.display = 'block';
    }

    function closeModal() {
      modal.style.display = 'none';
    }

    function editEntry(id) {
      const entry = scheduleData.find(item => item.id === id);
      if (entry) {
        openEditModal(entry);
      }
    }

    function deleteEntry(id) {
      if (confirm('Вы уверены, что хотите удалить это занятие?')) {
        scheduleData = scheduleData.filter(item => item.id !== id);
        saveToLocalStorage(); // Сохраняем изменения
        updateScheduleDOM();
        showNotification('Занятие удалено');
      }
    }

    function confirmDelete() {
      const id = document.getElementById('editId').value;
      if (id) {
        deleteEntry(id);
        closeModal();
      }
    }

    editForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('editId').value;
      const day = document.getElementById('editDay').value;
      const time = document.getElementById('editTime').value;
      const lesson = document.getElementById('editLesson').value;
      const students = document.getElementById('editStudents').value;
      const type = document.getElementById('editType').value;

      if (id) {
        // Редактирование
        const index = scheduleData.findIndex(item => item.id === id);
        if (index !== -1) {
          scheduleData[index] = { id, day, time, lesson, students, type };
        }
      } else {
        // Добавление нового
        const newId = generateId(day);
        scheduleData.push({ id: newId, day, time, lesson, students, type });
      }

      saveToLocalStorage(); // Сохраняем изменения
      updateScheduleDOM();
      closeModal();
      showNotification(id ? 'Занятие обновлено' : 'Занятие добавлено');
    });

    window.onclick = function(event) {
      if (event.target === modal) {
        closeModal();
      }
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
      initScheduleData(); // Загружаем данные
      updateScheduleDOM(); // Генерируем интерфейс
      
      // Уведомление при первой загрузке
      if (!window.hasShownNotificationOnLoad) {
        window.hasShownNotificationOnLoad = true;
        // Здесь можно показать приветственное уведомление
      }

      // Обновление каждую минуту
      setInterval(() => {
        if (currentOffset === 0) {
          updateNextLessonInfo();
        }
      }, 60000);
    });
  </script>
</body>
</html>
